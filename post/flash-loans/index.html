<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Flash Loans: An Initial Analysis</title>
		<link rel="alternate" type="application/rss+xml" title="RSS" href="/index.xml">
		<link rel="canonical" href="https://natchineth.com/post/flash-loans/">
		<link rel="shortcut icon" type="image/png" href="/apple-touch-icon-precomposed.png">
		
		
		<meta name="generator" content="Hugo 0.55.6" />

		
		<meta property="og:title" content="Flash Loans: An Initial Analysis" />
		<meta property="og:type" content="article" />
		<meta property="og:image" content="/img/default-header-img.jpg" />
		<meta property="og:description" content="" />
		<meta property="og:url" content="https://natchineth.com/post/flash-loans/" />
		<meta property="og:site_name" content="Flash Loans: An Initial Analysis" />
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:site" content="@" />


		
		<link rel="stylesheet" href="/css/tachyons.min.css" />
		<link rel="stylesheet" href="/css/story.css" />
		<link rel="stylesheet" href="/css/descartes.css" />
		
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
		<link href="https://fonts.googleapis.com/css?family=Quattrocento+Sans:400,400i,700,700i|Quattrocento:400,700|Spectral:400,400i,700,700i&amp;subset=latin-ext" rel="stylesheet">
		

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		
		<script src="/js/story.js"></script>

	</head>
	<body class="ma0 bg-white section-post page-kind-page is-page-true ">
		
		<header class="cover bg-top" style="background-image: url('/img/default-header-img.jpg'); background-position: center;">
				<div id="hdr" class="tc-l pv4-ns pv5-l pv2 ph3 ph4-ns">
					<h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">Flash Loans: An Initial Analysis</h1>
					<h2 class="near-white mt3-l mb4-l fw1 f6 f3-l subtitle measure-wide-l center lh-copy mt2 mb3">
						
						
							
								Published
								<time datetime="2020-07-23T11:33:34-04:00">Jul 23, 2020</time>
								<span class="display-print">by Natalie Chin</span>
								
								<span class="display-print">at https://natchineth.com/post/flash-loans/</span>
							
						
					</h2>
				</div>

				
				
				
				

			</div>

			<div class="bg-black-30 bb bt">
				<nav class="hide-print sans-serif  border-box pa3 ph5-l">
					<a href="https://natchineth.com" title="Home">
					</a>
					<img src="/img/logo.jpg" class="w2 h2 br-100" alt="Natalie Chin" />
					<div class="fr h2 pv2 tr">
						<a class="link f5 ml2 dim near-white" text-align = "centre" href="/">Home</a>
						<a class="link f5 ml2 dim near-white" text-align = "centre" href="/slides/">Slides</a>
						<a class="link f5 ml2 dim near-white" text-align = "centre" href="/talks/">Talks</a>
						<a class="link f5 ml2 dim near-white" href="mailto:natchin08@gmail.com"><i class="fas fa-envelope-open-text"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://github.com/NatalieChin80"><i class="fab fa-github-square"></i></a>
						<a class="link f5 ml2 dim near-white" href="https://www.linkedin.com/in/nataliechin80"><i class="fab fa-linkedin"></i></a>
						<a class="link f5 ml2 dim near-white fas fa-rss-square" href="index.xml" title="RSS Feed"></a>
						<a class="link f5 ml2 dim near-white fas fa-search" href="search/" role="search" title="Search"></a>
					</div>
				</nav>

		</header>
		
		<main role="main">
		
<article class="center bg-white br-3 pv1 ph4 lh-copy f5 nested-links mw7">
	<p>A flash loan is no-collateral loan existing over the span of a single transaction, allowing a contract to borrow funds, use funds, and repay the loan by the end of the same transaction. It&rsquo;s like being a millionnaire for 15 seconds.</p>

<h1 id="flash-loans">Flash Loans</h1>

<h2 id="what-are-flash-loans">What are flash loans?</h2>

<p>In the simplest terms possible, a flash loan is a loan that is exists over the span of a single transaction (15 seconds), allowing a contract to borrow funds, use the funds for purposes, and repay the loan + associated interest by the end of the transaction. The smart contract can put these funds through any system they want, as long as the amount + interest is sent back into the lending pool contract. Unlike Maker, no collateral is required for these loans. Flash loans ensure that the amount and the fee for borrowing is paid back to the lending pool by the end of the transaction, otherwise it reverts.</p>

<h2 id="how-do-they-work">How do they work?</h2>

<p>These flash loans execute in lending pools, which have checks to ensure that the smart contract has repaid their loans at the end of the transaction. If the flash loan is not returned, the entire transaction (including the borrowing of the loan) is reverted and the state rolls back.</p>

<p>While walking through <a href="https://github.com/aave/aave-protocol/blob/master/contracts/lendingpool/LendingPool.sol#L843">Aave&rsquo;s Lending Pool flashloan function</a> implementation in detail, the loan essentially execute __ main steps:</p>

<ol>
<li>Checks the available liquidity in the Lending Pool contract (reverts if the flash loan is too large)

<ul>
<li><em>reverts</em> if the flash loan is too large</li>
</ul></li>
<li>Calculates the protocol and amount fee

<ul>
<li><strong>user&rsquo;s total fee</strong>

<ul>
<li><code>amountFee = flash_loan_amount * FLASHLOAN_FEE_TOTAL / 10000</code></li>
</ul></li>
<li><strong>protocol fee</strong>

<ul>
<li><code>protocolFee = amountFee * FLASHLOAN_FEE_PROTOCOL / 10000</code></li>
</ul></li>
<li>Lending Pool Constants <a href="https://github.com/aave/aave-protocol/blob/master/contracts/configuration/LendingPoolParametersProvider.sol#L17">are defined here</a>

<ul>
<li><code>FLASHLOAN_FEE_TOTAL = 35</code></li>
<li><code>FLASHLOAN_FEE_PROTOCOL = 3000</code></li>
</ul></li>
<li><em>reverts</em> if either amount fee or protocol fee are &lt;0 - means that the amount is too small for a flash loan</li>
</ul></li>
<li>Transfers funds to a user&rsquo;s smart contract</li>
<li>Calls <code>reciever.executeOperation()</code>, the function that would need to be overridden to execute a flash loan

<ul>
<li>Aave&rsquo;s <a href="https://github.com/aave/flashloan-box/blob/master/contracts/Flashloan.sol#L14">Flashloan-box</a> repository sets up infrastructure for a developer to create a flash loan</li>
</ul></li>
<li>Checks to ensure that the available liquidity in the Lending Pool Contract is the same as step 1

<ul>
<li><em>reverts</em> if <code>currentLiquidity != previousLiquidity + amountFee</code></li>
</ul></li>
</ol>

<p>As seen above, flash loans target smart contract developers, unlike Maker/Compound. By implementing <code>executeOperation()</code>, a developer can choose what they want to spend their flash loan funds on.</p>

<h2 id="why-are-they-useful">Why are they useful?</h2>

<p>Flash loans help a variety of purposes, including:</p>

<h3 id="refinancing-debt">Refinancing Debt</h3>

<p>Flash loans enable users to get a better interest rate for debt that they&rsquo;ve taken out of a system.</p>

<p>Assume a user has put collateral down to take <code>$10k</code> from a system - this means that this user be required to pay back <code>$x + interest</code> in the future. If Company A is offering a 10% interest, and Company B is offering 5% interest, users would prefer to go with the lowest interest rate, as they prefer to pay less for the money they have borrowed.</p>

<table>
<thead>
<tr>
<th>Scenario</th>
<th>Company A</th>
<th>Company B</th>
</tr>
</thead>

<tbody>
<tr>
<td>&ldquo;Original&rdquo; Loan</td>
<td>debt = $10000 <br> interest = 10%</td>
<td>debt = $0 <br> interest = 5%</td>
</tr>

<tr>
<td>Better Rate</td>
<td>debt = $0 <br> interest = 10%</td>
<td>debt = $10000 <br> interest = 5%</td>
</tr>
</tbody>
</table>

<p>A flash loan could be written with the following steps to facilitate refinancing:</p>

<ol>
<li>Take out a flash loan in the amount sufficient to pay back the loan from Company A</li>
<li>Send the funds to Company A and unlock collateral, essentially paying back the loan and zero-ing the debt</li>
<li>Send collateral to Company B, and borrow funds at 5%</li>
<li>Pay flash loan back at the end of the transaction</li>
</ol>

<h3 id="collateral-swaps">Collateral Swaps</h3>

<p>Flash loans also enable users to change the underlying collateral mechanism, in systems such as Maker and Compound.</p>

<p>Assuming a user has to put ETH collateral into Maker to withdraw DAI, resulting in the user having an Ether-backed collateral. If a different collateral, such as BAT or USDC has a better borrowing rate, users may want to change the collateral type they use. Flash loans can be used to do this as well:</p>

<ol>
<li>Take out an ETH flash loan in the amount of the withdrawn DAI + interest</li>
<li>Swap ETH to other collateral (ie: USDC/BAT) on Uniswap</li>
<li>Deposit new collateral into Maker</li>
<li>Withdraw original ETH collateral from Maker</li>
<li>Payback ETH flashloan</li>
</ol>

<h1 id="lose-little-gain-everything-implications-on-defi-security">Lose Little, Gain Everything - Implications on DeFi Security</h1>

<p>While the DeFi space has always consisted of Lego blocks with applications like collaterlized debt, providing liquidity, or synthetic tokens, Flash loans bring on a whole new variant. Their lack of collateralization is due to a user&rsquo;s need to take the loan out, use the funds, and pay it back at the end of the same transaction. Flash loaners only pay the fee to take funds out of the lending pool - and can do anything they want with it thereafter.</p>

<p>This means an attacker could potentially take on less risk with a flash loan than executing an attack with their own funds. If an attacker attempts to attack a smart contract bug with their own funds, if they do it incorrectly, they have the <em>chance</em> of losing their own funds. With a flash loan in a smart contract, if their call to another platform&rsquo;s smart contract fails, the entire transaction will revert and it will be as if the attacker never really had the flash loan in the first place. In this way, flash loans enable these attackers to take on less risk while executing a smart contract attack.</p>

<h2 id="small-smart-contract-bugs-are-even-more-dangerous">Small smart contract bugs are even more dangerous</h2>

<p>For DeFi smart contracts, this means that smaller bugs, such as one allowing users to extract 0.01% more tokens than expected - which may not have been too big of a problem with small inputs such as 1ETH become increasingly more profitable for hackers via flash loans. In the past, these hackers would be limited to the amount of funds in their wallet - but flash loans allow these users to have access to a significantly larger funding pool.</p>

<p>Flash loans allow hackers, who wouldn&rsquo;t otherwise have sufficient funds - be millionnaires/trillionaires (dependent on the amount in the lending pool) for 15 seconds. During this time, they receive the funds, invoke the buggy smart contract and/or logic, return funds + fees to the lending pool, and pocket the remainder of the profits.</p>

<h2 id="anyone-can-be-a-whale">Anyone can be a whale</h2>

<p>Given that flash loans do not require collateral, these loans allow every-day users to become &ldquo;whales&rdquo; - users who hold a significantly large portion of funds - large enough to change supply/demand in their favour. This new requirement puts pressure on all DeFi systems to consider the ramifications of high-volume-high-value transactions executing through their platform.</p>

<p>Aside from individual DeFi platforms, whales with access to a significant pool of funds can affect largely token volume and trading. An example of this may be creating a large dip in supply and rise in demand, which opens up the opportunity for large profits when they sell their token supply at the end of the transaction.</p>

<h1 id="the-future-of-flash-loans">The Future of Flash Loans</h1>

<p>It will be really interesting to see the future development of flash loans and see other use cases that pop up. With the DeFi space continuously changing and projects pushing updates, it will also be incredibly interesting to see what other vulnerabilities and security implications flash loans bring up.</p>
</article>

		</main>
		
				<div class="hide-print sans-serif f6 f5-l mt5 ph3 pb6 center nested-copy-line-height lh-copy nested-links mw-100 measure-wide">
		<div class="about-the-author">
		
			
			
				
					<p>Natalie is a blockchain developer and blockchain professor, technical reviewer of Mastering Solidity, and an ambassador for females in technology.</p>

				
			
		
		</div>
		
	</div>

		
		
		
		<footer class="hide-print sans-serif f6 fw1 bg-black near-white bottom-0 w-100 pa3" role="contentinfo">
			<p class="w-50 fr tr">
			</p>
			<p class="w-50 near-white">
				&copy; 2020 Natalie Chin
			</p>
		</footer>
		
	
	
	</body>
</html>
